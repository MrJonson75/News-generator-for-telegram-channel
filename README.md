# ะะฐะบ ะฒัะต ัะฐะฑะพัะฐะตั

---

## 1. ะะตัะฐะฝะธะบะฐ ัะฐะฑะพัั ะฟะฐััะตัะฐ ะธ ะฒะทะฐะธะผะพะดะตะนััะฒะธะต ั ะฑะฐะทะพะน ะดะฐะฝะฝัั

ะกะธััะตะผะฐ ะฟะฐััะธะฝะณะฐ ะฝะพะฒะพััะตะน ััััะพะตะฝะฐ ะผะพะดัะปัะฝะพ ะธ ัะฐะฑะพัะฐะตั ัะตัะตะท Celery-ะทะฐะดะฐัะธ. ะัะฝะพะฒะฝะพะน ะฟะฐััะตั `parse_and_save_news` ะทะฐะฟััะบะฐะตััั ะฟะพ ัะฐัะฟะธัะฐะฝะธั (ะฝะฐะฟัะธะผะตั, ะบะฐะถะดัะต 30 ะผะธะฝัั) ะธ ัะพะฑะธัะฐะตั ะฝะพะฒะพััะธ ั ัะฐะทะฝัั ะธััะพัะฝะธะบะพะฒ: Habr, RBC ะธ Telegram. ะััะพัะฝะธะบะธ ะดะธะฝะฐะผะธัะตัะบะธ ะพะฟัะตะดะตะปััััั ะธะท ะฑะฐะทั ะดะฐะฝะฝัั `Source`: ะตัะปะธ ะฒ ััะพะปะฑัะต `enabled` ััะพะธั `True`, ัะพะพัะฒะตัััะฒัััะธะน ะฟะฐััะตั ะทะฐะฟััะบะฐะตััั; ะตัะปะธ `False` โ ะธััะพัะฝะธะบ ะฟัะพะฟััะบะฐะตััั. ะัะธ ะฟะตัะฒะพะผ ะทะฐะฟััะบะต, ะตัะปะธ ะฑะฐะทะฐ ะฟัััะฐ, ะธััะพัะฝะธะบะธ ะฟะพะดะณััะถะฐัััั ะธะท ะบะพะฝัะธะณััะฐัะธะธ ะธ ัะพะทะดะฐัััั ะฐะฒัะพะผะฐัะธัะตัะบะธ. ะะฐะถะดะฐั ัะพะฑัะฐะฝะฝะฐั ะฝะพะฒะพััั ะฒะฐะปะธะดะธััะตััั ัะตัะตะท Pydantic (`ParsedNewsSchema`), ัะธะปััััะตััั ะฟะพ ะบะปััะตะฒัะผ ัะปะพะฒะฐะผ ะธ ะดะตะดัะฟะปะธัะธััะตััั ะฟะพ URL. ะะพัะปะต ััะพะณะพ ะฝะพะฒะพััะธ ัะพััะฐะฝััััั ะฒ ัะฐะฑะปะธัั `NewsItem`, ะฐ ะฝะพะฒัะต ะธััะพัะฝะธะบะธ โ ะฒ `Source` ั ัะปะฐะณะพะผ `enabled=True`. ะขะฐะบะพะน ะฟะพะดัะพะด ะฟะพะทะฒะพะปัะตั ัะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพ ัะฟัะฐะฒะปััั ะธััะพัะฝะธะบะฐะผะธ, ะปะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต ะธ ะฑะตะทะพะฟะฐัะฝะพ ะผะฐัััะฐะฑะธัะพะฒะฐัั ัะธััะตะผั ะฟะฐััะธะฝะณะฐ.

```text
+------------------+        +------------------+
|     Celery       |        |    Scheduler     |
|  Task Worker     |<------>| (every 30 min)   |
+--------+---------+        +------------------+
|
v
+------------------+
|  news_collector  |
|  (dynamic tasks) |
+--------+---------+
|
v
+------------------+       +------------------+
| Parser Modules   |------>|  Source Enabled? |
| Habr / RBC / TG  |       |    DB Check      |
+--------+---------+       +------------------+
|
v
+------------------+
| Validate & Filter|
| (Pydantic & Keywords)|
+--------+---------+
|
v
+------------------+
| Deduplicate URLs |
+--------+---------+
|
v
+------------------+
|   Database       |
| NewsItem / Source|
+------------------+
```

* **Celery Worker** โ ะฒัะฟะพะปะฝัะตั ะทะฐะดะฐัั `parse_and_save_news`.
* **Scheduler** โ ะทะฐะฟััะบะฐะตั ะทะฐะดะฐัั ะฟะพ ัะฐัะฟะธัะฐะฝะธั.
* **news_collector** โ ัะฟัะฐะฒะปัะตั ะทะฐะฟััะบะพะผ ะฟะฐััะตัะพะฒ ะดะปั ะฐะบัะธะฒะฝัั ะธััะพัะฝะธะบะพะฒ.
* **Parser Modules** โ ะพัะดะตะปัะฝัะต ะฟะฐััะตัั ะดะปั ะบะฐะถะดะพะณะพ ะธััะพัะฝะธะบะฐ (Habr, RBC, Telegram).
* **Validate & Filter** โ ะฟัะพะฒะตัะบะฐ ััััะบัััั ะฝะพะฒะพััะธ ัะตัะตะท Pydantic, ัะธะปัััะฐัะธั ะฟะพ ะบะปััะตะฒัะผ ัะปะพะฒะฐะผ.
* **Deduplicate URLs** โ ัะดะฐะปะตะฝะธะต ะดัะฑะปะธะบะฐัะพะฒ ะฟะตัะตะด ัะพััะฐะฝะตะฝะธะตะผ.
* **Database** โ ััะฐะฝะตะฝะธะต ะธััะพัะฝะธะบะพะฒ ะธ ะฝะพะฒะพััะตะน ะฒ ัะฐะฑะปะธัะฐั `Source` ะธ `NewsItem`.

---

## 2. ะะตะฝะตัะฐัะพั ะฟะพััะพะฒ ะดะปั Telegram ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ Celery

ะะปั ะณะตะฝะตัะฐัะธะธ ะฟะพััะพะฒ ะธ ัะฟัะฐะฒะปะตะฝะธั ะธะผะธ ัะตะฐะปะธะทะพะฒะฐะฝั ะฝะตัะบะพะปัะบะพ ะฐัะธะฝััะพะฝะฝัั ะทะฐะดะฐั: `generate_posts`, `cleanup_old_failed_posts`, `generate_post_keywords`. ะะฝะธ ัะฐะฑะพัะฐัั ะฝะฐ ะฑะฐะทะต Celery, SQLAlchemy ะธ OpenAI GPT-4o-mini.

### 2.1 ะะฐะดะฐัะฐ `generate_posts`

**ะะฐะทะฝะฐัะตะฝะธะต:**
ะะตะฝะตัะฐัะธั ะฟะพััะพะฒ ะฝะฐ ะพัะฝะพะฒะต ะฝะพะฒะพััะตะน ะดะปั Telegram.

**ะะพะณะธะบะฐ ัะฐะฑะพัั:**

1. ะะพะปััะฐะตะผ ะฒัะต ะฝะพะฒะพััะธ ะธะท ะฑะฐะทั ะดะฐะฝะฝัั.
2. ะะปั ะบะฐะถะดะพะน ะฝะพะฒะพััะธ ะฟัะพะฒะตััะตะผ, ะตััั ะปะธ ัะถะต ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะน ะฟะพัั:

   * **published** โ ะฟัะพะฟััะบะฐะตะผ.
   * **failed** โ ะตัะปะธ ะฟัะตะฒััะตะฝ ะปะธะผะธั ะฟะพะฟััะพะบ (`MAX_RETRIES`), ัะดะฐะปัะตะผ ะฟะพัั ะธ ะฝะพะฒะพััั.
   * **generated** โ ะฟะตัะตะณะตะฝะตัะธััะตะผ ะฟะพัั.
3. ะะตะฝะตัะฐัะธั ัะตะบััะฐ ัะตัะตะท OpenAI GPT-4o-mini:

   * ะัะธะฑะบะธ API ัะฒะตะปะธัะธะฒะฐัั `retry_count` ะธ ัะพััะฐะฝััััั ะฒ `error_message`.
   * ะัััะพะน ัะตะบัั ัะฐะบะถะต ััะธััะฒะฐะตััั ะบะฐะบ ะพัะธะฑะบะฐ (ั ะฟะพัะปะตะดัััะตะน ะฟะพะผะตัะบะพะน `failed` ะฟะพัะปะต ะฟัะตะฒััะตะฝะธั ะปะธะผะธัะฐ ะฟะพะฟััะพะบ).
4. ะฃัะฟะตัะฝะฐั ะณะตะฝะตัะฐัะธั:

   * ะกะพะทะดะฐะตััั ะฝะพะฒัะน ะฟะพัั ัะพ ััะฐัััะพะผ `new` ะธะปะธ ะพะฑะฝะพะฒะปัะตััั ัััะตััะฒัััะธะน.
5. ะะณัะฐะฝะธัะตะฝะธะต ะฝะฐ ะบะพะปะธัะตััะฒะพ ะณะตะฝะตัะฐัะธะน ะทะฐ ะพะดะธะฝ ะทะฐะฟััะบ (`MAX_PER_RUN`).

**ะะปะฐะฝะธัะพะฒัะธะบ (Celery Beat):**
ะะฐะดะฐัะฐ ะทะฐะฟััะบะฐะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะบะฐะถะดัะต 10 ะผะธะฝัั.

---

### 2.2 ะะฐะดะฐัะฐ `cleanup_old_failed_posts`

**ะะฐะทะฝะฐัะตะฝะธะต:**
ะะฒัะพะผะฐัะธัะตัะบะฐั ะพัะธััะบะฐ ััะฐััั ะฟะพััะพะฒ ัะพ ััะฐัััะพะผ `failed` ะธ ัะฒัะทะฐะฝะฝัั ะฝะพะฒะพััะตะน ะดะปั ะฟะพะดะดะตัะถะฐะฝะธั ะฑะฐะทั ะดะฐะฝะฝัั ะฒ ัะธััะพัะต.

**ะะพะณะธะบะฐ ัะฐะฑะพัั:**

1. ะะฟัะตะดะตะปัะตััั ะดะฐัะฐ ะพััะตัะตะฝะธั: ัะตะบััะฐั ะดะฐัะฐ ะผะธะฝัั `days` (ะฟะพ ัะผะพะปัะฐะฝะธั 7).
2. ะัะฑะธัะฐัััั ะฟะพััั ัะพ ััะฐัััะพะผ `failed` ััะฐััะต ััะพะน ะดะฐัั.
3. ะะปั ะบะฐะถะดะพะณะพ ะฝะฐะนะดะตะฝะฝะพะณะพ ะฟะพััะฐ:

   * ะฃะดะฐะปัะตััั ัะฒัะทะฐะฝะฝะฐั ะฝะพะฒะพััั (ะตัะปะธ ะตััั).
   * ะฃะดะฐะปัะตััั ัะฐะผ ะฟะพัั.
4. ะะพะผะผะธั ะธะทะผะตะฝะตะฝะธะน ะฒ ะฑะฐะทั ะดะฐะฝะฝัั.

**ะะปะฐะฝะธัะพะฒัะธะบ (Celery Beat):**
ะะฐะดะฐัะฐ ะผะพะถะตั ะทะฐะฟััะบะฐัััั ะฟะตัะธะพะดะธัะตัะบะธ (ะฝะฐะฟัะธะผะตั, ัะฐะท ะฒ ะดะตะฝั).

---

### 2.3 ะะตะฝะตัะฐัะธั ัะตะณะพะฒ (ะบะปััะตะฒัั ัะปะพะฒ) ะดะปั ะฟะพััะพะฒ

ะะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะน ัะตะผะฐัะธัะตัะบะพะน ะบะปะฐััะธัะธะบะฐัะธะธ ะฟะพััะพะฒ ัะตะฐะปะธะทะพะฒะฐะฝะฐ ะทะฐะดะฐัะฐ `generate_post_keywords`.

**ะะพะณะธะบะฐ ัะฐะฑะพัั:**

1. ะะท ะฑะฐะทั ะฒัะฑะธัะฐัััั ะฟะพััั ัะพ ััะฐัััะฐะผะธ `new` ะธ `generated`.
2. ะัะพะฟััะบะฐัััั ะฟะพััั ะฑะตะท ัะตะบััะฐ ะธะปะธ ัะถะต ะธะผะตััะธะต ัะตะณะธ.
3. ะขะตะบัั ะฟะพััะฐ ะฐะฝะฐะปะธะทะธััะตััั ัะตัะตะท OpenAI ะดะปั ะณะตะฝะตัะฐัะธะธ ะบะปััะตะฒัั ัะปะพะฒ.
4. ะะปั ะบะฐะถะดะพะณะพ ัะปะพะฒะฐ:

   * ะัะพะฒะตััะตััั ะฝะฐะปะธัะธะต ะฒ ัะฐะฑะปะธัะต `Keyword`.
   * ะกะพะทะดะฐัััั ะฝะพะฒัะน Keyword, ะตัะปะธ ะตะณะพ ะฝะตั.
   * ะฃััะฐะฝะฐะฒะปะธะฒะฐะตััั ัะฒัะทั many-to-many ั Post.
5. ะัะต ัะตะทัะปััะฐัั ะบะพะผะผะธััััั ะฒ ะฑะฐะทั.

**ะะปะฐะฝะธัะพะฒัะธะบ (Celery Beat):**
ะะฐะฟััะบะฐะตััั ะบะฐะถะดัะต 15โ30 ะผะธะฝัั ะธะปะธ ัะธะฝััะพะฝะฝะพ ั ะณะตะฝะตัะฐัะธะตะน ะฟะพััะพะฒ.

---

## 3. API ะดะปั ัะฐะฑะพัั ั ะฟะพััะฐะผะธ

### 3.1 ะะพะปััะตะฝะธะต ะฟะพััะพะฒ

**GET `/api/posts`** โ ัะฟะธัะพะบ ะฟะพััะพะฒ ั ัะธะปัััะฐัะธะตะน ะธ ะฟะฐะณะธะฝะฐัะธะตะน:

* `status` โ ัะธะปััั ะฟะพ ััะฐัััั (`new`, `generated`, `published`, `failed`)
* `page` โ ะฝะพะผะตั ัััะฐะฝะธัั
* `size` โ ะบะพะปะธัะตััะฒะพ ะฟะพััะพะฒ ะฝะฐ ัััะฐะฝะธัะต

**ะัะธะผะตั:**

```
GET /api/posts?status=new&page=1&size=10
```

**Swagger:** ะฟะพะบะฐะทัะฒะฐัััั ะฟัะธะผะตัั ะทะฐะฟัะพัะพะฒ ะธ ะพะฟะธัะฐะฝะธะต ะบะฐะถะดะพะณะพ ะฟะฐัะฐะผะตััะฐ.

---

### 3.2 ะะพะปััะตะฝะธะต ะพะดะฝะพะณะพ ะฟะพััะฐ

**GET `/api/posts/{post_id}`** โ ะฒะพะทะฒัะฐัะฐะตั ะบะพะฝะบัะตัะฝัะน ะฟะพัั ะฟะพ ID.

**ะัะธะผะตั:**

```
GET /api/posts/9250e8ec-9ebf-41bb-a5d7-9287a5380024
```

---

### 3.3 ะะทะผะตะฝะตะฝะธะต ััะฐัััะฐ ะฟะพััะฐ

**PATCH `/api/posts/{post_id}/status`** โ ะธะทะผะตะฝะตะฝะธะต ััะฐัััะฐ ะฟะพััะฐ (`new`, `generated`, `published`, `failed`).

**ะัะธะผะตั ะทะฐะฟัะพัะฐ:**

```json
{
  "status": "published"
}
```

---

### 3.4 ะฃะดะฐะปะตะฝะธะต ะฟะพััะฐ

**DELETE `/api/posts/{post_id}`** โ ัะดะฐะปะตะฝะธะต ะฟะพััะฐ ะฟะพ ID.

**ะัะธะผะตั:**

```
DELETE /api/posts/9250e8ec-9ebf-41bb-a5d7-9287a5380024
```

---

### 3.5 ะััะฝะฐั ะณะตะฝะตัะฐัะธั ะฟะพััะพะฒ

**POST `/api/generate`** โ ะทะฐะฟััะบะฐะตั ะณะตะฝะตัะฐัะธั ะฟะพััะพะฒ ัะตัะตะท Celery ะฒัััะฝัั.

---

### 3.6 ะัะฑะปะธะบะฐัะธั ะฟะพััะฐ ะฒ Telegram

**POST `/api/posts/{post_id}/publish`** โ ะฟัะฑะปะธะบะฐัะธั ะฟะพััะฐ. ะะตะฝัะตั ััะฐััั ะฝะฐ `published`.
ะะปั ะฟัะฑะปะธะบะฐัะธะธ ะฟะพัั ะดะพะปะถะตะฝ ะฑััั ะฒ ััะฐัััะต `generated`.

---

## 4. Health-check

### 4.1 ะัะพะฒะตัะบะฐ ัะฐะฑะพัั ัะตัะฒะตัะฐ

**GET `/health`** โ ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั ะฑะฐะทั ะดะฐะฝะฝัั ะธ OpenAI.

**ะัะธะผะตั ะพัะฒะตัะฐ:**

```json
{
  "status": "ok",
  "database": "โ Database connection OK: 1",
  "openai": "ok"
}
```

---

### 4.2 ะัะพะฒะตัะบะฐ Celery ะธ Redis

**GET `/health/celery`** โ ะฟัะพะฒะตัะบะฐ ัะพััะพัะฝะธั Celery, Celery Beat ะธ ะพัะตัะตะดะตะน Redis:

**ะะพะทะฒัะฐัะฐะตั:**

* `status` โ ัะพััะพัะฝะธะต ะฒะพัะบะตัะพะฒ
* `workers` โ ัะฟะธัะพะบ ะฐะบัะธะฒะฝัั ะฒะพัะบะตัะพะฒ
* `active_tasks` โ ัะตะบััะธะต ะฐะบัะธะฒะฝัะต ะทะฐะดะฐัะธ
* `scheduled_tasks` โ ะพัะปะพะถะตะฝะฝัะต ะทะฐะดะฐัะธ (ัะฐะนะผะตัั)
* `reserved_tasks` โ ะทะฐะดะฐัะธ ะฒ ะพัะตัะตะดะธ

**ะัะธะผะตั ะพัะฒะตัะฐ:**

```json
{
  "status": "ok",
  "workers": ["worker1@host"],
  "active_tasks": {"worker1@host": []},
  "scheduled_tasks": {"worker1@host": []},
  "reserved_tasks": {"worker1@host": []}
}
```

---

### 5. ะัะฟะพะปัะทัะตะผัะต ัะตัะฝะพะปะพะณะธะธ

* **Python 3.11+**
* **FastAPI** โ ะฒะตะฑ-ััะตะนะผะฒะพัะบ ะดะปั API
* **SQLAlchemy** โ ะฐัะธะฝััะพะฝะฝะฐั ัะฐะฑะพัะฐ ั ะฑะฐะทะพะน ะดะฐะฝะฝัั
* **Celery** โ ะฐัะธะฝััะพะฝะฝัะต ะทะฐะดะฐัะธ
* **Redis** โ ะฑัะพะบะตั ัะพะพะฑัะตะฝะธะน ะดะปั Celery
* **OpenAI GPT-4o-mini** โ ะณะตะฝะตัะฐัะธั ัะตะบััะฐ ะธ ัะตะณะพะฒ
* **Celery Beat** โ ะฐะฒัะพะผะฐัะธัะตัะบะธะน ะฟะปะฐะฝะธัะพะฒัะธะบ ะทะฐะดะฐั
* **Pydantic** โ ะฒะฐะปะธะดะฐัะธั ะดะฐะฝะฝัั
* **Swagger / OpenAPI** โ ะดะพะบัะผะตะฝัะฐัะธั API ั ะฟัะธะผะตัะฐะผะธ

---

```text
๐ฐ  NewsItem (DB) โ ะฝะพะฒะพััะธ, ัะพะฑัะฐะฝะฝัะต ะฟะฐััะตัะพะผ
   |
   v
๐ค  generate_posts (Celery Task)
   |
   |---> ะฟัะพะฒะตัะบะฐ ัััะตััะฒัััะธั ะฟะพััะพะฒ
   |
   v
๐  Post (DB)
   โโ ััะฐััั: ๐ข new
   โโ ััะฐััั: ๐ก generated
   โโ ััะฐััั: ๐ด failed
   โโ ัะฒัะทั: keywords (ัะตัะตะท post_keywords)
   |
   v
๐  /api/posts/{id}/publish
   โโ ะธะทะผะตะฝะตะฝะธะต ััะฐัััะฐ ะฝะฐ ๐ฃ published
   |
   v
๐ท  generate_post_keywords (Celery Task)
   โโ ะฐะฒัะพะผะฐัะธัะตัะบะฐั ะณะตะฝะตัะฐัะธั ะบะปััะตะฒัั ัะปะพะฒ
        ะดะปั ะฟะพััะฐ
        โโ ะดะพะฑะฐะฒะปะตะฝะธะต ะฒ Keyword (DB)
        โโ ัะฒัะทั ะผะฝะพะณะธะต-ะบะพ-ะผะฝะพะณะธะผ ั Post
```

---

### ๐น ะะตะณะตะฝะดะฐ emoji

* ๐ฐ โ ะฝะพะฒะพััั (NewsItem)
* ๐ค โ Celery ะทะฐะดะฐัะฐ ะณะตะฝะตัะฐัะธะธ ะฟะพััะพะฒ (`generate_posts`)
* ๐ โ ัะณะตะฝะตัะธัะพะฒะฐะฝะฝัะน ะฟะพัั (Post)
* ๐ข โ ััะฐััั `new`
* ๐ก โ ััะฐััั `generated`
* ๐ด โ ััะฐััั `failed`
* ๐ฃ โ ััะฐััั `published`
* ๐ท โ Celery ะทะฐะดะฐัะฐ ะณะตะฝะตัะฐัะธะธ ัะตะณะพะฒ (`generate_post_keywords`)

---

### ๐น ะัะธะผะตัั ะฟะพัะพะบะพะฒ

1. **ะะพะฒะฐั ะฝะพะฒะพััั โ ะณะตะฝะตัะฐัะธั ะฟะพััะฐ โ ะฟัะฑะปะธะบะฐัะธั**

```
๐ฐ NewsItem โ ๐ค generate_posts โ ๐ Post (๐ข new) โ ๐ publish โ ๐ Post (๐ฃ published) โ ๐ท generate_post_keywords โ ๐ท Keyword
```

2. **ะะตัะดะฐัะฝะฐั ะณะตะฝะตัะฐัะธั โ ะพัะธััะบะฐ**

```
๐ฐ NewsItem โ ๐ค generate_posts โ ๐ Post (๐ด failed) โ โป๏ธ cleanup_old_failed_posts โ ัะดะฐะปะตะฝะธะต ะฟะพััะฐ ะธ ะฝะพะฒะพััะธ
```

3. **ะะพะฒัะพัะฝะฐั ะณะตะฝะตัะฐัะธั (generated โ regenerate)**

```
๐ Post (๐ก generated) โ ๐ค generate_posts โ ๐ Post (๐ก generated updated) โ ๐ท generate_post_keywords
```

---

### ๐น ะงัะพ ะฒะธะดะฝะพ ะฝะฐ ััะตะผะต

* ะะตัั ะฟััั ะฟะพััะฐ: **ัะพะทะดะฐะฝะธะต โ ะณะตะฝะตัะฐัะธั โ ะฟัะฑะปะธะบะฐัะธั โ ัะตะณะธัะพะฒะฐะฝะธะต**
* ะฆะฒะตัะฐ ะธ emoji ััะฐะทั ะฟะพะบะฐะทัะฒะฐัั **ััะฐัััั ะฟะพััะพะฒ**
* ะะพะดะบะปััะตะฝั **Celery ะทะฐะดะฐัะธ**, **ัะฝะดะฟะพะธะฝัั API** ะธ **ััััะบัััะฐ ะะ**
* ะะตะณะบะพ ัะธัะฐัั ะธ ะฒััะฐะฒะปััั ะฟััะผะพ ะฒ README

---


